---
# =============================================================================
# Playbook: 05-identities.yml
# Description: Create Active Directory User Accounts
# Tags: identities, users, admin
# =============================================================================

- name: "[IDENTITIES] - Provision User Accounts"
  hosts: domain_controllers
  gather_facts: no
  tags: [identities, users]

  vars:
    domain_dn: "DC={{ ad_domain.name.split('.')[0] }},DC={{ ad_domain.name.split('.')[1] }}"
    domain_name: "{{ ad_domain.name }}"

  tasks:

    - name: "[IDENTITIES] - Create Tier 0 Admin"
      microsoft.ad.user:
        name: "adm-t0-{{ ad_domain.netbios | lower }}"
        firstname: "Admin"
        surname: "Tier0"
        password: "{{ ad_domain.safe_mode_password }}"
        password_never_expires: false
        user_cannot_change_password: false
        state: present
        path: "OU=Accounts,OU=Tier0,OU=Admin,{{ domain_dn }}"
        description: "Tier 0 Admin - RESTRICTED ACCESS"
        enabled: true
        groups:
          add:
            - "T0-Admins"
            - "Domain Admins"
        attributes:
          set:
            adminDescription: "Tier 0 Account - DC Access Only"
      tags: [tier0, admin]

    - name: "[IDENTITIES] - Create Tier 1 Admin"
      microsoft.ad.user:
        name: "adm-t1-{{ ad_domain.netbios | lower }}"
        firstname: "Admin"
        surname: "Tier1"
        password: "{{ ad_domain.safe_mode_password }}"
        password_never_expires: false
        state: present
        path: "OU=Accounts,OU=Tier1,OU=Admin,{{ domain_dn }}"
        description: "Tier 1 Admin - Member Servers"
        enabled: true
        groups:
          add:
            - "T1-Admins"
        attributes:
          set:
            adminDescription: "Tier 1 Account - Servers Only"
      tags: [tier1, admin]

    - name: "[IDENTITIES] - Create Tier 2 Admin"
      microsoft.ad.user:
        name: "adm-t2-{{ ad_domain.netbios | lower }}"
        firstname: "Admin"
        surname: "Tier2"
        password: "{{ ad_domain.safe_mode_password }}"
        password_never_expires: false
        state: present
        path: "OU=Accounts,OU=Tier2,OU=Admin,{{ domain_dn }}"
        description: "Tier 2 Admin - Workstations"
        enabled: true
        groups:
          add:
            - "T2-Admins"
        attributes:
          set:
            adminDescription: "Tier 2 Account - Workstations Only"
      tags: [tier2, admin]

    - name: "[IDENTITIES] - Create Defined Users (Vars)"
      microsoft.ad.user:
        name: "{{ item.username }}"
        firstname: "{{ item.firstname | default('User') }}"
        surname: "{{ item.lastname | default(item.username) }}"
        password: "{{ item.password }}"
        password_never_expires: false
        user_cannot_change_password: false
        state: present
        path: "OU=Users,{{ domain_dn }}"
        description: "Auto-generated User"
        enabled: true
        email: "{{ item.username }}@{{ domain_name }}"
        groups:
          add: "{{ item.groups | default(['Domain Users']) }}"
        update_password: on_create
      loop: "{{ ad_users | default([]) }}"
      when: ad_users is defined and ad_users | length > 0
      tags: [standard_users]

    - name: "[IDENTITIES] - Create Demo Users (If None Defined)"
      microsoft.ad.user:
        name: "{{ item.username }}"
        firstname: "{{ item.firstname }}"
        surname: "{{ item.lastname }}"
        password: "Demo@P4ssw0rd!"
        password_never_expires: false
        state: present
        path: "OU={{ item.department }},OU=Users,{{ domain_dn }}"
        description: "Demo User - {{ item.department }}"
        enabled: true
        email: "{{ item.username }}@{{ domain_name }}"
        company: "{{ ad_domain.netbios }}"
        department: "{{ item.department }}"
        title: "{{ item.title }}"
        groups:
          add:
            - "Domain Users"
      loop:
        - username: "j.dupont"
          firstname: "Jean"
          lastname: "Dupont"
          department: "IT"
          title: "System Administrator"
        - username: "m.martin"
          firstname: "Marie"
          lastname: "Martin"
          department: "HR"
          title: "HR Manager"
        - username: "p.durand"
          firstname: "Pierre"
          lastname: "Durand"
          department: "Finance"
          title: "Accountant"
        - username: "s.bernard"
          firstname: "Sophie"
          lastname: "Bernard"
          department: "Management"
          title: "CEO"
        - username: "l.petit"
          firstname: "Luc"
          lastname: "Petit"
          department: "Sales"
          title: "Sales Representative"
      when: (ad_users is not defined) or (ad_users | length == 0)
      tags: [demo]

    - name: "[IDENTITIES] - Create gMSA Group"
      microsoft.ad.group:
        name: "GRP-gMSA-Authorized"
        scope: global
        category: security
        path: "OU=Service-Accounts,{{ domain_dn }}"
        description: "Servers authorized to use gMSAs"
        state: present
      tags: [gmsa]

    - name: "[IDENTITIES] - Summary"
      ansible.builtin.debug:
        msg: "Identities provisioned successfully."
