---
# =============================================================================
# Playbook: 06-hardening.yml
# Description: Apply ANSSI Hardening Recommendations (PA-099)
# Tags: hardening, security, anssi
# =============================================================================

- name: "[HARDENING] - Apply ANSSI Security Policies"
  hosts: domain_controllers
  gather_facts: yes
  tags: [hardening, security]

  vars:
    domain_dn: "DC={{ ad_domain.name.split('.')[0] }},DC={{ ad_domain.name.split('.')[1] }}"
    hardening: "{{ hardening_level | default('anssi') }}"

  tasks:

    - name: "[HARDENING] - Configure Password Policy"
      ansible.windows.win_shell: |
        Import-Module ActiveDirectory
        Set-ADDefaultDomainPasswordPolicy -Identity "{{ ad_domain.name }}" -MinPasswordLength {{ password_policy.min_length }} -PasswordHistoryCount {{ password_policy.history_count }} -MaxPasswordAge "{{ password_policy.max_age_days }}.00:00:00" -MinPasswordAge "{{ password_policy.min_age_days }}.00:00:00" -ComplexityEnabled $true -LockoutThreshold {{ password_policy.lockout_threshold }} -LockoutDuration "00:{{ password_policy.lockout_duration_minutes }}:00" -ReversibleEncryptionEnabled $false
      tags: [password_policy]

    - name: "[HARDENING] - Disable LM Hash Storage"
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
        name: NoLMHash
        data: 1
        type: dword
      tags: [registry, lsa]

    - name: "[HARDENING] - Force NTLMv2"
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
        name: LmCompatibilityLevel
        data: 5
        type: dword
      when: hardening in ['anssi', 'paranoid']
      tags: [registry, ntlm]

    - name: "[HARDENING] - Restrict Anonymous Enumeration"
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
        name: RestrictAnonymous
        data: 1
        type: dword
      tags: [registry]

    - name: "[HARDENING] - Require SMB Server Signing"
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters
        name: RequireSecuritySignature
        data: 1
        type: dword
      when: anssi_security.smb_signing_required | default(true)
      tags: [smb]

    - name: "[HARDENING] - Disable SMBv1 Protocol"
      ansible.windows.win_optional_feature:
        name: SMB1Protocol
        state: absent
      when: hardening in ['standard', 'anssi', 'paranoid']
      tags: [smb]

    - name: "[HARDENING] - Enable LSASS Protection (RunAsPPL)"
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
        name: RunAsPPL
        data: 1
        type: dword
      when: anssi_security.lsass_protection_enabled | default(true)
      tags: [lsass]

    - name: "[HARDENING] - Disable WDigest"
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest
        name: UseLogonCredential
        data: 0
        type: dword
      tags: [lsass]

    - name: "[HARDENING] - Set Event Log Sizes"
      ansible.windows.win_shell: |
        wevtutil sl Security /ms:1073741824
        wevtutil sl System /ms:134217728
        wevtutil sl Application /ms:134217728
      tags: [logs]

    - name: "[HARDENING] - Summary"
      ansible.builtin.debug:
        msg: "ANSSI Hardening Applied - Level {{ hardening | upper }}"
