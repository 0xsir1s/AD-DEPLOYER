---
# =============================================================================
# Playbook: 07-create-gpos.yml
# Description: Création et configuration des GPOs de sécurité
# =============================================================================

- name: Création des GPOs de sécurité
  hosts: domain_controllers
  gather_facts: no

  vars:
    domain_dn: "DC={{ ad_domain.name.split('.')[0] }},DC={{ ad_domain.name.split('.')[1] }}"

  tasks:

    - name: Vérification du module GroupPolicy
      ansible.windows.win_shell: |
        if (Get-Module -ListAvailable -Name GroupPolicy) {
          Write-Output "Module GroupPolicy disponible"
        } else {
          Import-Module ServerManager
          Add-WindowsFeature GPMC -IncludeAllSubFeature
          Write-Output "Module GroupPolicy installé"
        }
      register: gp_module

    - name: Création GPO - Restrictions Tier 0
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        $gpoName = "SEC-Tier0-Restrictions"
        $gpo = Get-GPO -Name $gpoName -ErrorAction SilentlyContinue
        if (-not $gpo) {
          $gpo = New-GPO -Name $gpoName -Comment "Restrictions Tier 0 - ANSSI"
          Write-Output "GPO créée: $gpoName"
        } else {
          Write-Output "GPO existante: $gpoName"
        }
        $ouPath = "OU=Tier0,OU=Admin,{{ domain_dn }}"
        $link = Get-GPLink -Guid $gpo.Id.Guid -Target $ouPath -ErrorAction SilentlyContinue
        if (-not $link) {
          New-GPLink -Guid $gpo.Id.Guid -Target $ouPath -LinkEnabled Yes
          Write-Output "GPO liée"
        }
      register: gpo_tier0

    - name: Création GPO - Restrictions Tier 1
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        $gpoName = "SEC-Tier1-Restrictions"
        $gpo = Get-GPO -Name $gpoName -ErrorAction SilentlyContinue
        if (-not $gpo) {
          $gpo = New-GPO -Name $gpoName -Comment "Restrictions Tier 1 - ANSSI"
          Write-Output "GPO créée: $gpoName"
        } else {
          Write-Output "GPO existante: $gpoName"
        }
        $ouPath = "OU=Tier1,OU=Admin,{{ domain_dn }}"
        $link = Get-GPLink -Guid $gpo.Id.Guid -Target $ouPath -ErrorAction SilentlyContinue
        if (-not $link) {
          New-GPLink -Guid $gpo.Id.Guid -Target $ouPath -LinkEnabled Yes
          Write-Output "GPO liée"
        }
      register: gpo_tier1

    - name: Création GPO - Restrictions Tier 2
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        $gpoName = "SEC-Tier2-Restrictions"
        $gpo = Get-GPO -Name $gpoName -ErrorAction SilentlyContinue
        if (-not $gpo) {
          $gpo = New-GPO -Name $gpoName -Comment "Restrictions Tier 2 - ANSSI"
          Write-Output "GPO créée: $gpoName"
        } else {
          Write-Output "GPO existante: $gpoName"
        }
        $ouPath = "OU=Tier2,OU=Admin,{{ domain_dn }}"
        $link = Get-GPLink -Guid $gpo.Id.Guid -Target $ouPath -ErrorAction SilentlyContinue
        if (-not $link) {
          New-GPLink -Guid $gpo.Id.Guid -Target $ouPath -LinkEnabled Yes
          Write-Output "GPO liée"
        }
      register: gpo_tier2

    - name: Création GPO - Politique audit avancée
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        $gpoName = "SEC-AuditPolicy"
        $gpo = Get-GPO -Name $gpoName -ErrorAction SilentlyContinue
        if (-not $gpo) {
          $gpo = New-GPO -Name $gpoName -Comment "Politique audit avancée - ANSSI"
          Write-Output "GPO créée: $gpoName"
          Set-GPRegistryValue -Name $gpoName -Key "HKLM\System\CurrentControlSet\Control\Lsa" -ValueName "SCENoApplyLegacyAuditPolicy" -Type DWord -Value 1
        }
        $link = Get-GPLink -Guid $gpo.Id.Guid -Target "{{ domain_dn }}" -ErrorAction SilentlyContinue
        if (-not $link) {
          New-GPLink -Guid $gpo.Id.Guid -Target "{{ domain_dn }}" -LinkEnabled Yes
          Write-Output "GPO liée au domaine"
        }
      register: gpo_audit

    - name: Création GPO - Désactivation NTLMv1
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        $gpoName = "SEC-DisableNTLMv1"
        $gpo = Get-GPO -Name $gpoName -ErrorAction SilentlyContinue
        if (-not $gpo) {
          $gpo = New-GPO -Name $gpoName -Comment "Désactivation NTLMv1 - ANSSI"
          Set-GPRegistryValue -Name $gpoName -Key "HKLM\System\CurrentControlSet\Control\Lsa" -ValueName "LmCompatibilityLevel" -Type DWord -Value 5
          Set-GPRegistryValue -Name $gpoName -Key "HKLM\System\CurrentControlSet\Control\Lsa" -ValueName "NoLMHash" -Type DWord -Value 1
          Write-Output "GPO créée: $gpoName"
        }
        $link = Get-GPLink -Guid $gpo.Id.Guid -Target "{{ domain_dn }}" -ErrorAction SilentlyContinue
        if (-not $link) {
          New-GPLink -Guid $gpo.Id.Guid -Target "{{ domain_dn }}" -LinkEnabled Yes
        }
      register: gpo_ntlm

    - name: Création GPO - Signature SMB obligatoire
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        $gpoName = "SEC-SMBSigning"
        $gpo = Get-GPO -Name $gpoName -ErrorAction SilentlyContinue
        if (-not $gpo) {
          $gpo = New-GPO -Name $gpoName -Comment "Signature SMB obligatoire - ANSSI"
          Set-GPRegistryValue -Name $gpoName -Key "HKLM\System\CurrentControlSet\Services\LanmanServer\Parameters" -ValueName "RequireSecuritySignature" -Type DWord -Value 1
          Set-GPRegistryValue -Name $gpoName -Key "HKLM\System\CurrentControlSet\Services\LanmanServer\Parameters" -ValueName "EnableSecuritySignature" -Type DWord -Value 1
          Set-GPRegistryValue -Name $gpoName -Key "HKLM\System\CurrentControlSet\Services\LanmanWorkstation\Parameters" -ValueName "RequireSecuritySignature" -Type DWord -Value 1
          Set-GPRegistryValue -Name $gpoName -Key "HKLM\System\CurrentControlSet\Services\LanmanWorkstation\Parameters" -ValueName "EnableSecuritySignature" -Type DWord -Value 1
          Write-Output "GPO créée: $gpoName"
        }
        $link = Get-GPLink -Guid $gpo.Id.Guid -Target "{{ domain_dn }}" -ErrorAction SilentlyContinue
        if (-not $link) {
          New-GPLink -Guid $gpo.Id.Guid -Target "{{ domain_dn }}" -LinkEnabled Yes
        }
      register: gpo_smb

    - name: Création GPO - Protection LSASS
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        $gpoName = "SEC-LSASSProtection"
        $gpo = Get-GPO -Name $gpoName -ErrorAction SilentlyContinue
        if (-not $gpo) {
          $gpo = New-GPO -Name $gpoName -Comment "Protection LSASS - ANSSI"
          Set-GPRegistryValue -Name $gpoName -Key "HKLM\System\CurrentControlSet\Control\Lsa" -ValueName "RunAsPPL" -Type DWord -Value 1
          Set-GPRegistryValue -Name $gpoName -Key "HKLM\System\CurrentControlSet\Control\SecurityProviders\WDigest" -ValueName "UseLogonCredential" -Type DWord -Value 0
          Write-Output "GPO créée: $gpoName"
        }
        $link = Get-GPLink -Guid $gpo.Id.Guid -Target "{{ domain_dn }}" -ErrorAction SilentlyContinue
        if (-not $link) {
          New-GPLink -Guid $gpo.Id.Guid -Target "{{ domain_dn }}" -LinkEnabled Yes
        }
      register: gpo_lsass

    - name: Création GPO - Postes de travail
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        $gpoName = "SEC-Workstations"
        $gpo = Get-GPO -Name $gpoName -ErrorAction SilentlyContinue
        if (-not $gpo) {
          $gpo = New-GPO -Name $gpoName -Comment "Configuration sécurité postes de travail"
          Write-Output "GPO créée: $gpoName"
        }
        $ouPath = "OU=Postes,{{ domain_dn }}"
        $link = Get-GPLink -Guid $gpo.Id.Guid -Target $ouPath -ErrorAction SilentlyContinue
        if (-not $link) {
          New-GPLink -Guid $gpo.Id.Guid -Target $ouPath -LinkEnabled Yes -ErrorAction SilentlyContinue
          Write-Output "GPO liée"
        }
      register: gpo_workstations
      failed_when: false

    - name: Création GPO - Serveurs
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        $gpoName = "SEC-Servers"
        $gpo = Get-GPO -Name $gpoName -ErrorAction SilentlyContinue
        if (-not $gpo) {
          $gpo = New-GPO -Name $gpoName -Comment "Configuration sécurité serveurs membres"
          Write-Output "GPO créée: $gpoName"
        }
        $ouPath = "OU=Serveurs,{{ domain_dn }}"
        $link = Get-GPLink -Guid $gpo.Id.Guid -Target $ouPath -ErrorAction SilentlyContinue
        if (-not $link) {
          New-GPLink -Guid $gpo.Id.Guid -Target $ouPath -LinkEnabled Yes -ErrorAction SilentlyContinue
          Write-Output "GPO liée"
        }
      register: gpo_servers
      failed_when: false

    - name: Création du Central Store pour les modèles ADMX
      ansible.windows.win_shell: |
        $policyDefPath = "\\{{ ad_domain.name }}\SYSVOL\{{ ad_domain.name }}\Policies\PolicyDefinitions"
        if (-not (Test-Path $policyDefPath)) {
          New-Item -Path $policyDefPath -ItemType Directory -Force
          New-Item -Path "$policyDefPath\en-US" -ItemType Directory -Force
          New-Item -Path "$policyDefPath\fr-FR" -ItemType Directory -Force
          $localADMX = "C:\Windows\PolicyDefinitions"
          if (Test-Path $localADMX) {
            Copy-Item -Path "$localADMX\*.admx" -Destination $policyDefPath -Force
            Copy-Item -Path "$localADMX\en-US\*.adml" -Destination "$policyDefPath\en-US" -Force
            if (Test-Path "$localADMX\fr-FR") {
              Copy-Item -Path "$localADMX\fr-FR\*.adml" -Destination "$policyDefPath\fr-FR" -Force
            }
          }
          Write-Output "Central Store créé"
        } else {
          Write-Output "Central Store existant"
        }
      register: central_store

    - name: Forçage de la mise à jour des GPOs
      ansible.windows.win_shell: gpupdate /force
      register: gpupdate

    - name: Liste des GPOs créées
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        Get-GPO -All | Select-Object DisplayName, Id, GpoStatus, CreationTime | ConvertTo-Json
      register: gpo_list
      changed_when: false

    - name: Affichage des GPOs
      ansible.builtin.debug:
        msg: "{{ gpo_list.stdout | from_json }}"

    - name: Résumé
      ansible.builtin.debug:
        msg: "GPOs de sécurité créées avec succès"
