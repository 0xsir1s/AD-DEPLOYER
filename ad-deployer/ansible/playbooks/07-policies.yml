---
# =============================================================================
# Playbook: 07-policies.yml
# Description: Create and Link Security GPOs
# Tags: policies, gpo, gpmc
# =============================================================================

- name: "[POLICIES] - Deploy Group Policy Objects"
  hosts: domain_controllers
  gather_facts: no
  tags: [policies, gpo]

  vars:
    domain_dn: "DC={{ ad_domain.name.split('.')[0] }},DC={{ ad_domain.name.split('.')[1] }}"

  tasks:

    - name: "[POLICIES] - Verify GroupPolicy Module"
      ansible.windows.win_shell: |
        if (Get-Module -ListAvailable -Name GroupPolicy) { Write-Output "Found" } else { Install-WindowsFeature GPMC; Write-Output "Installed" }
      changed_when: false

    - name: "[POLICIES] - Create Tier 0 Restrictions GPO"
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        $gpoName = "SEC-Tier0-Restrictions"
        if (-not (Get-GPO -Name $gpoName -ErrorAction SilentlyContinue)) {
          New-GPO -Name $gpoName -Comment "Tier 0 Restrictions - ANSSI"
        }
        $ouPath = "OU=Tier0,OU=Admin,{{ domain_dn }}"
        if (-not (Get-GPLink -Guid (Get-GPO -Name $gpoName).Id.Guid -Target $ouPath -ErrorAction SilentlyContinue)) {
          New-GPLink -Name $gpoName -Target $ouPath -LinkEnabled Yes
        }
      tags: [tier0]

    - name: "[POLICIES] - Create Tier 1 Restrictions GPO"
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        $gpoName = "SEC-Tier1-Restrictions"
        if (-not (Get-GPO -Name $gpoName -ErrorAction SilentlyContinue)) { New-GPO -Name $gpoName }
        $ouPath = "OU=Tier1,OU=Admin,{{ domain_dn }}"
        New-GPLink -Name $gpoName -Target $ouPath -LinkEnabled Yes -ErrorAction SilentlyContinue
      tags: [tier1]

    - name: "[POLICIES] - Create Audit Policy GPO"
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        $gpoName = "SEC-AuditPolicy"
        if (-not (Get-GPO -Name $gpoName -ErrorAction SilentlyContinue)) {
          New-GPO -Name $gpoName
          Set-GPRegistryValue -Name $gpoName -Key "HKLM\System\CurrentControlSet\Control\Lsa" -ValueName "SCENoApplyLegacyAuditPolicy" -Type DWord -Value 1
        }
        New-GPLink -Name $gpoName -Target "{{ domain_dn }}" -LinkEnabled Yes -ErrorAction SilentlyContinue
      tags: [audit]

    - name: "[POLICIES] - Create SMB Signing GPO"
      ansible.windows.win_shell: |
        Import-Module GroupPolicy
        $gpoName = "SEC-SMBSigning"
        if (-not (Get-GPO -Name $gpoName -ErrorAction SilentlyContinue)) {
          New-GPO -Name $gpoName
          Set-GPRegistryValue -Name $gpoName -Key "HKLM\System\CurrentControlSet\Services\LanmanServer\Parameters" -ValueName "RequireSecuritySignature" -Type DWord -Value 1
        }
        New-GPLink -Name $gpoName -Target "{{ domain_dn }}" -LinkEnabled Yes -ErrorAction SilentlyContinue
      tags: [smb]

    - name: "[POLICIES] - Summary"
      ansible.builtin.debug:
        msg: "GPOs created successfully."
