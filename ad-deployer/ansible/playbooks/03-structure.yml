---
# =============================================================================
# Playbook: 03-structure.yml
# Description: Create OU Structure (ANSSI Tiering)
# Tags: structure, ou, tiering
# =============================================================================

- name: "[STRUCTURE] - Deploy OU Hierarchy"
  hosts: domain_controllers
  gather_facts: no
  tags: [structure, ou]

  vars:
    domain_dn: "DC={{ ad_domain.name.split('.')[0] }},DC={{ ad_domain.name.split('.')[1] }}"

  tasks:

    - name: "[STRUCTURE] - Create Root Admin OU"
      microsoft.ad.ou:
        name: "Admin"
        path: "{{ domain_dn }}"
        description: "Administrative Accounts & Groups"
        state: present
        protect_from_deletion: true

    - name: "[STRUCTURE] - Create Tier OUs (0, 1, 2)"
      microsoft.ad.ou:
        name: "{{ item.name }}"
        path: "OU=Admin,{{ domain_dn }}"
        description: "{{ item.description }}"
        state: present
        protect_from_deletion: true
      loop:
        - name: "Tier0"
          description: "Tier 0 - Domain Controllers & AD Admin"
        - name: "Tier1"
          description: "Tier 1 - Member Servers"
        - name: "Tier2"
          description: "Tier 2 - Workstations"

    - name: "[STRUCTURE] - Create Sub-OUs for Tiers"
      microsoft.ad.ou:
        name: "{{ item.sub_ou }}"
        path: "OU={{ item.parent }},OU=Admin,{{ domain_dn }}"
        state: present
        protect_from_deletion: true
      loop:
        - { parent: "Tier0", sub_ou: "Accounts" }
        - { parent: "Tier0", sub_ou: "Groups" }
        - { parent: "Tier0", sub_ou: "Computers" }
        - { parent: "Tier1", sub_ou: "Accounts" }
        - { parent: "Tier1", sub_ou: "Groups" }
        - { parent: "Tier1", sub_ou: "Computers" }
        - { parent: "Tier2", sub_ou: "Accounts" }
        - { parent: "Tier2", sub_ou: "Groups" }
        - { parent: "Tier2", sub_ou: "Computers" }

    - name: "[STRUCTURE] - Create Organizational OUs"
      microsoft.ad.ou:
        name: "{{ item }}"
        path: "{{ domain_dn }}"
        state: present
        protect_from_deletion: true
      loop:
        - "Users"
        - "Groups"
        - "Service-Accounts"
        - "Servers"
        - "Workstations"
        - "Quarantine"
      tags: [org]

    - name: "[STRUCTURE] - Create Department OUs"
      microsoft.ad.ou:
        name: "{{ item }}"
        path: "OU=Users,{{ domain_dn }}"
        state: present
      loop:
        - "IT"
        - "HR"
        - "Finance"
        - "Marketing"
        - "Sales"
        - "Management"
      tags: [org, depts]

    - name: "[STRUCTURE] - Summary"
      ansible.builtin.debug:
        msg: "OU Structure deployed successfully."
